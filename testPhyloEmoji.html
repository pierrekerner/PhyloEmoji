<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de Phylog√©nie Emoji</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .question {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 30px;
            color: #444;
            line-height: 1.6;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .organisms {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }
        
        .organism-box {
            text-align: center;
        }
        
        .organism {
            font-size: 4.5em;
            padding: 20px;
            background: #fff;
            border-radius: 15px;
            border: 4px solid #e0e0e0;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .organism-label {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        .choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .choice {
            padding: 20px;
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
            text-align: center;
        }
        
        .choice:hover {
            background: #e3f2fd;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .choice.correct {
            background: #c8e6c9;
            border-color: #4caf50;
            font-weight: bold;
        }
        
        .choice.incorrect {
            background: #ffcdd2;
            border-color: #f44336;
        }
        
        .choice.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .feedback {
            margin-top: 25px;
            padding: 25px;
            border-radius: 15px;
            display: none;
            line-height: 1.8;
        }
        
        .feedback.show {
            display: block;
        }
        
        .feedback.correct {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            border: 3px solid #4caf50;
        }
        
        .feedback.incorrect {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
            border: 3px solid #f44336;
        }
        
        .feedback-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .feedback-content {
            font-size: 1em;
            color: #333;
        }
        
        .time-info {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        
        .time-value {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .next-btn {
            margin-top: 20px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            display: none;
            margin-left: auto;
            margin-right: auto;
            transition: transform 0.2s;
        }
        
        .next-btn.show {
            display: block;
        }
        
        .next-btn:hover {
            transform: scale(1.05);
        }
        
        .taxonomy-info {
            font-style: italic;
            margin-top: 10px;
            font-size: 0.95em;
        }
        
        .mode-selection {
            text-align: center;
        }
        
        .mode-title {
            font-size: 1.3em;
            color: #333;
            margin: 40px 0 30px 0;
            font-weight: 600;
        }
        
        .mode-options {
            display: flex;
            gap: 25px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        
        .mode-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            padding: 40px 30px;
            width: 250px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: #667eea;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .mode-emoji {
            font-size: 5em;
            margin-bottom: 20px;
        }
        
        .mode-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .mode-description {
            font-size: 0.95em;
            color: #666;
            line-height: 1.4;
        }
        
        .game-mode-indicator {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-mode-indicator span {
            font-size: 1.1em;
            color: #667eea;
            font-weight: 600;
        }
        
        .change-mode-btn {
            padding: 8px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .change-mode-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <div id="modeSelection" class="mode-selection">
            <h1>üå≥ Phylog√©nie des Emojis üå≥</h1>
            <div class="subtitle">Identifiez les deux organismes les plus proches phylog√©n√©tiquement</div>
            
            <div class="mode-title">Choisissez votre jeu</div>
            
            <div class="mode-options">
                <div class="mode-card" onclick="selectGameMode('plants')">
                    <div class="mode-emoji">üåø</div>
                    <div class="mode-name">Plantes</div>
                    <div class="mode-description">Angiospermes et gymnospermes</div>
                </div>
                
                <div class="mode-card" onclick="selectGameMode('animals')">
                    <div class="mode-emoji">ü¶Å</div>
                    <div class="mode-name">Animaux</div>
                    <div class="mode-description">Mammif√®res, oiseaux, reptiles, insectes...</div>
                </div>
                
                <div class="mode-card" onclick="selectGameMode('all')">
                    <div class="mode-emoji">üåç</div>
                    <div class="mode-name">Tout le vivant</div>
                    <div class="mode-description">Plantes, animaux, champignons</div>
                </div>
            </div>
        </div>
        
        <div id="questionCountSelection" style="display: none;" class="mode-selection">
            <h1>üå≥ Phylog√©nie des Emojis üå≥</h1>
            <div class="subtitle">Combien de questions voulez-vous ?</div>
            
            <div class="mode-title">Choisissez la dur√©e de la session</div>
            
            <div class="mode-options">
                <div class="mode-card" onclick="startGameWithCount(10)">
                    <div class="mode-emoji">‚ö°</div>
                    <div class="mode-name">Session rapide</div>
                    <div class="mode-description">10 questions (~5 minutes)</div>
                </div>
                
                <div class="mode-card" onclick="startGameWithCount(25)">
                    <div class="mode-emoji">üéØ</div>
                    <div class="mode-name">Session standard</div>
                    <div class="mode-description">25 questions (~12 minutes)</div>
                </div>
                
                <div class="mode-card" onclick="startGameWithCount(100)">
                    <div class="mode-emoji">üèÜ</div>
                    <div class="mode-name">Session marathon</div>
                    <div class="mode-description">100 questions (~50 minutes)</div>
                </div>
            </div>
            
            <button class="change-mode-btn" style="margin: 20px auto; display: block;" onclick="backToModeSelection()">‚Üê Retour au choix du mode</button>
        </div>
        
        <div id="gameContent" style="display: none;">
            <h1>üå≥ Phylog√©nie des Emojis üå≥</h1>
            <div class="subtitle">Identifiez les deux organismes les plus proches phylog√©n√©tiquement</div>
            
            <div class="game-mode-indicator">
                <span id="currentMode"></span>
                <button class="change-mode-btn" onclick="returnToMenu()">Changer de mode</button>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Score</div>
                    <div class="stat-value"><span id="score">0</span> / <span id="total">0</span></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Taux de r√©ussite</div>
                    <div class="stat-value" id="percentage">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Progression</div>
                    <div class="stat-value"><span id="questionNum">1</span> / <span id="maxQuestions">10</span></div>
                </div>
            </div>
            
            <div class="question">
                Parmi ces trois organismes, quels sont les <strong>deux qui partagent l'anc√™tre commun le plus r√©cent</strong> ?
            </div>
            
            <div class="organisms" id="organisms"></div>
            
            <div class="choices" id="choices"></div>
            
            <div class="feedback" id="feedback"></div>
            
            <button class="next-btn" id="nextBtn" onclick="nextQuestion()">Question suivante ‚ûú</button>
        </div>
    </div>

    <script>
        // Variables globales
        let score = 0;
        let total = 0;
        let questionNumber = 1;
        let currentQuestion = null;
        let gameMode = 'all';
        let availableOrganisms = [];
        let askedQuestions = [];
        let usedCorrectPairs = []; // Nouvelle variable pour suivre les paires correctes
        let maxQuestions = 10;
        let selectedGameMode = null;

        // Base de donn√©es des organismes
        const organisms = [
            { emoji: 'üçé', name: 'Pomme', latin: 'Malus domestica', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Malus', genus: 'Malus' },
            { emoji: 'üçê', name: 'Poire', latin: 'Pyrus communis', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Pyrus', genus: 'Pyrus' },
            { emoji: 'üçë', name: 'P√™che', latin: 'Prunus persica', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Prunus-peche', genus: 'Prunus' },
            { emoji: 'üçí', name: 'Cerise', latin: 'Prunus avium', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Prunus-cerise', genus: 'Prunus' },
            { emoji: 'üçì', name: 'Fraise', latin: 'Fragaria ananassa', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Fragaria', genus: 'Fragaria' },
            { emoji: 'üåπ', name: 'Rose', latin: 'Rosa spp.', family: 'Rosaceae', order: 'Rosales', class: 'Angiospermes', species: 'Rosa', genus: 'Rosa' },
            { emoji: 'üçÖ', name: 'Tomate', latin: 'Solanum lycopersicum', family: 'Solanaceae', order: 'Solanales', class: 'Angiospermes', species: 'Solanum-tomate', genus: 'Solanum' },
            { emoji: 'üçÜ', name: 'Aubergine', latin: 'Solanum melongena', family: 'Solanaceae', order: 'Solanales', class: 'Angiospermes', species: 'Solanum-aubergine', genus: 'Solanum' },
            { emoji: 'ü•î', name: 'Pomme de terre', latin: 'Solanum tuberosum', family: 'Solanaceae', order: 'Solanales', class: 'Angiospermes', species: 'Solanum-pomme', genus: 'Solanum' },
            { emoji: 'üåΩ', name: 'Ma√Øs', latin: 'Zea mays', family: 'Poaceae', order: 'Poales', class: 'Angiospermes', species: 'Zea', genus: 'Zea' },
            { emoji: 'üåæ', name: 'Riz', latin: 'Oryza sativa', family: 'Poaceae', order: 'Poales', class: 'Angiospermes', species: 'Oryza', genus: 'Oryza' },
            { emoji: 'üå≤', name: 'Conif√®re', latin: 'Pinus spp.', family: 'Pinaceae', order: 'Pinales', class: 'Gymnospermes', species: 'Pinus', genus: 'Pinus' },
            { emoji: 'üê±', name: 'Chat domestique', latin: 'Felis catus', family: 'Felidae', order: 'Carnivora', class: 'Mammalia', species: 'Felis', genus: 'Felis' },
            { emoji: 'ü¶Å', name: 'Lion', latin: 'Panthera leo', family: 'Felidae', order: 'Carnivora', class: 'Mammalia', species: 'Panthera-lion', genus: 'Panthera' },
            { emoji: 'üêØ', name: 'Tigre', latin: 'Panthera tigris', family: 'Felidae', order: 'Carnivora', class: 'Mammalia', species: 'Panthera-tigre', genus: 'Panthera' },
            { emoji: 'üê∂', name: 'Chien domestique', latin: 'Canis familiaris', family: 'Canidae', order: 'Carnivora', class: 'Mammalia', species: 'Canis-chien', genus: 'Canis' },
            { emoji: 'üê∫', name: 'Loup gris', latin: 'Canis lupus', family: 'Canidae', order: 'Carnivora', class: 'Mammalia', species: 'Canis-loup', genus: 'Canis' },
            { emoji: 'ü¶ä', name: 'Renard roux', latin: 'Vulpes vulpes', family: 'Canidae', order: 'Carnivora', class: 'Mammalia', species: 'Vulpes', genus: 'Vulpes' },
            { emoji: 'üêª', name: 'Ours brun', latin: 'Ursus arctos', family: 'Ursidae', order: 'Carnivora', class: 'Mammalia', species: 'Ursus', genus: 'Ursus' },
            { emoji: 'üêº', name: 'Panda g√©ant', latin: 'Ailuropoda melanoleuca', family: 'Ursidae', order: 'Carnivora', class: 'Mammalia', species: 'Ailuropoda', genus: 'Ailuropoda' },
            { emoji: 'üêò', name: '√âl√©phant d\'Afrique', latin: 'Loxodonta africana', family: 'Elephantidae', order: 'Proboscidea', class: 'Mammalia', species: 'Loxodonta', genus: 'Loxodonta' },
            { emoji: 'üê¥', name: 'Cheval domestique', latin: 'Equus caballus', family: 'Equidae', order: 'Perissodactyla', class: 'Mammalia', species: 'Equus-cheval', genus: 'Equus' },
            { emoji: 'ü¶ì', name: 'Z√®bre', latin: 'Equus quagga', family: 'Equidae', order: 'Perissodactyla', class: 'Mammalia', species: 'Equus-zebre', genus: 'Equus' },
            { emoji: 'üêÆ', name: 'Vache domestique', latin: 'Bos taurus', family: 'Bovidae', order: 'Artiodactyla', class: 'Mammalia', species: 'Bos', genus: 'Bos' },
            { emoji: 'üêê', name: 'Ch√®vre domestique', latin: 'Capra hircus', family: 'Bovidae', order: 'Artiodactyla', class: 'Mammalia', species: 'Capra', genus: 'Capra' },
            { emoji: 'üêë', name: 'Mouton domestique', latin: 'Ovis aries', family: 'Bovidae', order: 'Artiodactyla', class: 'Mammalia', species: 'Ovis', genus: 'Ovis' },
            { emoji: 'üê≠', name: 'Souris domestique', latin: 'Mus musculus', family: 'Muridae', order: 'Rodentia', class: 'Mammalia', species: 'Mus', genus: 'Mus' },
            { emoji: 'üêÄ', name: 'Rat surmulot', latin: 'Rattus norvegicus', family: 'Muridae', order: 'Rodentia', class: 'Mammalia', species: 'Rattus', genus: 'Rattus' },
            { emoji: 'üê∞', name: 'Lapin de garenne', latin: 'Oryctolagus cuniculus', family: 'Leporidae', order: 'Lagomorpha', class: 'Mammalia', species: 'Oryctolagus', genus: 'Oryctolagus' },
            { emoji: 'üêî', name: 'Poule domestique', latin: 'Gallus gallus', family: 'Phasianidae', order: 'Galliformes', class: 'Aves', species: 'Gallus', genus: 'Gallus' },
            { emoji: 'ü¶Ü', name: 'Canard colvert', latin: 'Anas platyrhynchos', family: 'Anatidae', order: 'Anseriformes', class: 'Aves', species: 'Anas', genus: 'Anas' },
            { emoji: 'ü¶Ö', name: 'Aigle royal', latin: 'Aquila chrysaetos', family: 'Accipitridae', order: 'Accipitriformes', class: 'Aves', species: 'Aquila', genus: 'Aquila' },
            { emoji: 'üêä', name: 'Crocodile du Nil', latin: 'Crocodylus niloticus', family: 'Crocodylidae', order: 'Crocodilia', class: 'Reptilia', species: 'Crocodylus', genus: 'Crocodylus' },
            { emoji: 'üêç', name: 'Python r√©ticul√©', latin: 'Python reticulatus', family: 'Pythonidae', order: 'Squamata', class: 'Reptilia', species: 'Python', genus: 'Python' },
            { emoji: 'ü¶é', name: 'L√©zard des murailles', latin: 'Podarcis muralis', family: 'Lacertidae', order: 'Squamata', class: 'Reptilia', species: 'Podarcis', genus: 'Podarcis' },
            { emoji: 'üê∏', name: 'Grenouille rousse', latin: 'Rana temporaria', family: 'Ranidae', order: 'Anura', class: 'Amphibia', species: 'Rana', genus: 'Rana' },
            { emoji: 'üêü', name: 'Poisson-z√®bre', latin: 'Danio rerio', family: 'Cyprinidae', order: 'Cypriniformes', class: 'Actinopterygii', species: 'Danio', genus: 'Danio' },
            { emoji: 'ü¶à', name: 'Grand requin blanc', latin: 'Carcharodon carcharias', family: 'Lamnidae', order: 'Lamniformes', class: 'Chondrichthyes', species: 'Carcharodon', genus: 'Carcharodon' },
            { emoji: 'ü¶ã', name: 'Monarque', latin: 'Danaus plexippus', family: 'Nymphalidae', order: 'Lepidoptera', class: 'Insecta', species: 'Danaus', genus: 'Danaus' },
            { emoji: 'üêù', name: 'Abeille mellif√®re', latin: 'Apis mellifera', family: 'Apidae', order: 'Hymenoptera', class: 'Insecta', species: 'Apis', genus: 'Apis' },
            { emoji: 'üêú', name: 'Fourmi rousse', latin: 'Formica rufa', family: 'Formicidae', order: 'Hymenoptera', class: 'Insecta', species: 'Formica', genus: 'Formica' },
            { emoji: 'üêû', name: 'Coccinelle', latin: 'Coccinella septempunctata', family: 'Coccinellidae', order: 'Coleoptera', class: 'Insecta', species: 'Coccinella', genus: 'Coccinella' },
            { emoji: 'üï∑Ô∏è', name: 'Araign√©e √©peire', latin: 'Araneus diadematus', family: 'Araneidae', order: 'Araneae', class: 'Arachnida', species: 'Araneus', genus: 'Araneus' },
            { emoji: 'ü¶Ç', name: 'Scorpion', latin: 'Centruroides sculpturatus', family: 'Buthidae', order: 'Scorpiones', class: 'Arachnida', species: 'Centruroides', genus: 'Centruroides' },
            { emoji: 'ü¶Ä', name: 'Tourteau', latin: 'Cancer pagurus', family: 'Cancridae', order: 'Decapoda', class: 'Malacostraca', species: 'Cancer', genus: 'Cancer' },
            { emoji: 'ü¶û', name: 'Homard am√©ricain', latin: 'Homarus americanus', family: 'Nephropidae', order: 'Decapoda', class: 'Malacostraca', species: 'Homarus', genus: 'Homarus' },
            { emoji: 'üêå', name: 'Escargot de Bourgogne', latin: 'Helix pomatia', family: 'Helicidae', order: 'Stylommatophora', class: 'Gastropoda', species: 'Helix', genus: 'Helix' },
            { emoji: 'üêô', name: 'Pieuvre commune', latin: 'Octopus vulgaris', family: 'Octopodidae', order: 'Octopoda', class: 'Cephalopoda', species: 'Octopus', genus: 'Octopus' },
            { emoji: 'üçÑ', name: 'Champignon de Paris', latin: 'Agaricus bisporus', family: 'Agaricaceae', order: 'Agaricales', class: 'Fungi', species: 'Agaricus', genus: 'Agaricus' }
        ];

        // Temps de divergence (simplifi√©)
        const divergenceTimes = {
            'Mammalia-Aves': 320,
            'Mammalia-Reptilia': 320,
            'Mammalia-Amphibia': 360,
            'Mammalia-Actinopterygii': 435,
            'Mammalia-Insecta': 750,
            'Mammalia-Arachnida': 750,
            'Aves-Reptilia': 255,
            'Carnivora-Artiodactyla': 86,
            'Carnivora-Rodentia': 92,
            'Felidae-Canidae': 52,
            'Felidae-Ursidae': 52,
            'Rosales-Solanales': 110,
            'Rosales-Poales': 120
        };

        function getDivergenceTime(org1, org2) {
            if (org1.species === org2.species) return 0;
            if (org1.genus === org2.genus) return 10;
            if (org1.family === org2.family) return 30;
            
            const key1 = org1.family + '-' + org2.family;
            const key2 = org2.family + '-' + org1.family;
            if (divergenceTimes[key1]) return divergenceTimes[key1];
            if (divergenceTimes[key2]) return divergenceTimes[key2];
            
            const key3 = org1.order + '-' + org2.order;
            const key4 = org2.order + '-' + org1.order;
            if (divergenceTimes[key3]) return divergenceTimes[key3];
            if (divergenceTimes[key4]) return divergenceTimes[key4];
            
            const key5 = org1.class + '-' + org2.class;
            const key6 = org2.class + '-' + org1.class;
            if (divergenceTimes[key5]) return divergenceTimes[key5];
            if (divergenceTimes[key6]) return divergenceTimes[key6];
            
            if (org1.class !== org2.class) return 800;
            if (org1.order !== org2.order) return 100;
            return 50;
        }

        function findCommonClade(org1, org2) {
            // M√™me esp√®ce
            if (org1.species === org2.species) return { level: 'esp√®ce', name: org1.name };
            
            // M√™me genre
            if (org1.genus === org2.genus) return { level: 'genre', name: org1.genus };
            
            // M√™me famille
            if (org1.family === org2.family) return { level: 'famille', name: org1.family };
            
            // M√™me ordre
            if (org1.order === org2.order) return { level: 'ordre', name: org1.order };
            
            // CLADES DES MAMMIF√àRES (Boreoeutheria)
            
            // FERUNGULATA (Carnivores + Ongul√©s + Pholidotes + Ch√©iropt√®res)
            const ferungulata = ['Carnivora', 'Artiodactyla', 'Perissodactyla', 'Cetacea'];
            if (org1.class === 'Mammalia' && org2.class === 'Mammalia') {
                if (ferungulata.includes(org1.order) && ferungulata.includes(org2.order)) {
                    // Si un est Carnivore et l'autre Ongul√©
                    if (org1.order === 'Carnivora' && (org2.order === 'Artiodactyla' || org2.order === 'Perissodactyla' || org2.order === 'Cetacea')) {
                        return { level: 'clade', name: 'Ferungulata' };
                    }
                    if (org2.order === 'Carnivora' && (org1.order === 'Artiodactyla' || org1.order === 'Perissodactyla' || org1.order === 'Cetacea')) {
                        return { level: 'clade', name: 'Ferungulata' };
                    }
                    // Si les deux sont des ongul√©s
                    if ((org1.order === 'Artiodactyla' || org1.order === 'Perissodactyla' || org1.order === 'Cetacea') &&
                        (org2.order === 'Artiodactyla' || org2.order === 'Perissodactyla' || org2.order === 'Cetacea')) {
                        return { level: 'clade', name: 'Ungulata (Ongul√©s)' };
                    }
                }
                
                // LAURASIATHERIA (Carnivores + Ongul√©s + Ch√©iropt√®res + Eulipotyphes)
                const laurasiatheria = ['Carnivora', 'Artiodactyla', 'Perissodactyla', 'Cetacea', 'Chiroptera', 'Eulipotyphla'];
                if (laurasiatheria.includes(org1.order) && laurasiatheria.includes(org2.order)) {
                    return { level: 'super-ordre', name: 'Laurasiatheria' };
                }
                
                // EUARCHONTOGLIRES (Primates + Rongeurs + Lagomorphes + Dermopt√®res + Scandentiens)
                const euarchontoglires = ['Primates', 'Rodentia', 'Lagomorpha'];
                if (euarchontoglires.includes(org1.order) && euarchontoglires.includes(org2.order)) {
                    // GLIRES (Rongeurs + Lagomorphes)
                    if ((org1.order === 'Rodentia' || org1.order === 'Lagomorpha') &&
                        (org2.order === 'Rodentia' || org2.order === 'Lagomorpha')) {
                        return { level: 'grand-ordre', name: 'Glires' };
                    }
                    // EUARCHONTOGLIRES
                    return { level: 'super-ordre', name: 'Euarchontoglires' };
                }
                
                // AFROTHERIA (√âl√©phants + Sir√©niens + Hyraco√Ødes + Macrosc√©lid√©s + Afrosoricides + Tubulident√©s)
                const afrotheria = ['Proboscidea'];
                if (afrotheria.includes(org1.order) && afrotheria.includes(org2.order)) {
                    return { level: 'super-ordre', name: 'Afrotheria' };
                }
                
                // Si Afrotheria vs Boreoeutheria
                if ((afrotheria.includes(org1.order) && !afrotheria.includes(org2.order)) ||
                    (afrotheria.includes(org2.order) && !afrotheria.includes(org1.order))) {
                    return { level: 'infra-classe', name: 'Placentalia (Mammif√®res placentaires)' };
                }
            }
            
            // M√™me classe
            if (org1.class === org2.class) return { level: 'classe', name: org1.class };
            
            // Cas sp√©ciaux - Clades importants
            
            // ARCHOSAURES (Oiseaux + Crocodiliens)
            if ((org1.class === 'Aves' && org2.order === 'Crocodilia') ||
                (org2.class === 'Aves' && org1.order === 'Crocodilia')) {
                return { level: 'clade', name: 'Archosaures' };
            }
            
            // SAUROPSIDES (Oiseaux + Reptiles)
            if ((org1.class === 'Aves' && org2.class === 'Reptilia') ||
                (org2.class === 'Aves' && org1.class === 'Reptilia')) {
                return { level: 'clade', name: 'Sauropsides' };
            }
            
            // AMNIOTES (Mammif√®res + Oiseaux + Reptiles)
            if ((org1.class === 'Mammalia' || org1.class === 'Aves' || org1.class === 'Reptilia') &&
                (org2.class === 'Mammalia' || org2.class === 'Aves' || org2.class === 'Reptilia')) {
                return { level: 'clade', name: 'Amniotes' };
            }
            
            // TETRAPODES (Mammif√®res + Oiseaux + Reptiles + Amphibiens)
            if ((org1.class === 'Mammalia' || org1.class === 'Aves' || org1.class === 'Reptilia' || org1.class === 'Amphibia') &&
                (org2.class === 'Mammalia' || org2.class === 'Aves' || org2.class === 'Reptilia' || org2.class === 'Amphibia')) {
                return { level: 'clade', name: 'T√©trapodes' };
            }
            
            // VERTEBRES (tous les animaux avec colonne vert√©brale)
            const vertebrates = ['Mammalia', 'Aves', 'Reptilia', 'Amphibia', 'Actinopterygii', 'Chondrichthyes'];
            if (vertebrates.includes(org1.class) && vertebrates.includes(org2.class)) {
                return { level: 'embranchement', name: 'Vert√©br√©s (Chordata)' };
            }
            
            // ARTHROPODES
            const arthropods = ['Insecta', 'Arachnida', 'Malacostraca'];
            if (arthropods.includes(org1.class) && arthropods.includes(org2.class)) {
                return { level: 'embranchement', name: 'Arthropodes' };
            }
            
            // MOLLUSQUES
            const mollusks = ['Gastropoda', 'Cephalopoda'];
            if (mollusks.includes(org1.class) && mollusks.includes(org2.class)) {
                return { level: 'embranchement', name: 'Mollusques' };
            }
            
            // PROTOSTOMIENS (Arthropodes + Mollusques)
            const protostomes = ['Insecta', 'Arachnida', 'Malacostraca', 'Gastropoda', 'Cephalopoda'];
            if (protostomes.includes(org1.class) && protostomes.includes(org2.class)) {
                return { level: 'clade', name: 'Protostomiens' };
            }
            
            // BILAT√âRIENS (tous les animaux sauf Cnidaires et √âponges)
            const bilaterians = ['Mammalia', 'Aves', 'Reptilia', 'Amphibia', 'Actinopterygii', 'Chondrichthyes',
                                'Insecta', 'Arachnida', 'Malacostraca', 'Gastropoda', 'Cephalopoda'];
            if (bilaterians.includes(org1.class) && bilaterians.includes(org2.class)) {
                return { level: 'clade', name: 'Bilat√©riens' };
            }
            
            // METAZOAIRES (tous les animaux)
            const animals = ['Mammalia', 'Aves', 'Reptilia', 'Amphibia', 'Actinopterygii', 'Chondrichthyes',
                            'Insecta', 'Arachnida', 'Malacostraca', 'Gastropoda', 'Cephalopoda', 'Anthozoa'];
            if (animals.includes(org1.class) && animals.includes(org2.class)) {
                return { level: 'r√®gne', name: 'M√©tazoaires (Animaux)' };
            }
            
            // PLANTES - Spermatophytes (plantes √† graines)
            if ((org1.class === 'Angiospermes' || org1.class === 'Gymnospermes') &&
                (org2.class === 'Angiospermes' || org2.class === 'Gymnospermes')) {
                return { level: 'clade', name: 'Spermatophytes (plantes √† graines)' };
            }
            
            // CHAMPIGNONS
            if (org1.class === 'Fungi' && org2.class === 'Fungi') {
                return { level: 'r√®gne', name: 'Champignons (Fungi)' };
            }
            
            // EUCARYOTES (tous)
            return { level: 'domaine', name: 'Eucaryotes' };
        }

        function getQuestionSignature(org1, org2, org3) {
            const ids = [org1.species, org2.species, org3.species].sort();
            return ids.join('|');
        }

        function getPairSignature(org1, org2) {
            const ids = [org1.species, org2.species].sort();
            return ids.join('|');
        }

        function selectGameMode(mode) {
            selectedGameMode = mode;
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('questionCountSelection').style.display = 'block';
        }

        function backToModeSelection() {
            selectedGameMode = null;
            document.getElementById('questionCountSelection').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        function startGameWithCount(numQuestions) {
            maxQuestions = numQuestions;
            gameMode = selectedGameMode;
            
            if (gameMode === 'plants') {
                availableOrganisms = organisms.filter(o => 
                    o.class === 'Angiospermes' || o.class === 'Gymnospermes'
                );
                const modeEl = document.getElementById('currentMode');
                if (modeEl) modeEl.textContent = 'üåø Mode Plantes (' + numQuestions + ' questions)';
            } else if (gameMode === 'animals') {
                availableOrganisms = organisms.filter(o => 
                    o.class === 'Mammalia' || o.class === 'Aves' || o.class === 'Reptilia' || 
                    o.class === 'Amphibia' || o.class === 'Actinopterygii' || o.class === 'Chondrichthyes' ||
                    o.class === 'Insecta' || o.class === 'Arachnida' || o.class === 'Malacostraca' ||
                    o.class === 'Gastropoda' || o.class === 'Cephalopoda'
                );
                const modeEl = document.getElementById('currentMode');
                if (modeEl) modeEl.textContent = 'ü¶Å Mode Animaux (' + numQuestions + ' questions)';
            } else {
                availableOrganisms = organisms;
                const modeEl = document.getElementById('currentMode');
                if (modeEl) modeEl.textContent = 'üåç Mode Tout le vivant (' + numQuestions + ' questions)';
            }
            
            score = 0;
            total = 0;
            questionNumber = 1;
            askedQuestions = [];
            usedCorrectPairs = []; // R√©initialiser aussi les paires utilis√©es
            
            // Masquer les √©crans de s√©lection
            document.getElementById('questionCountSelection').style.display = 'none';
            document.getElementById('gameContent').style.display = 'block';
            
            // Mettre √† jour les affichages avec v√©rifications
            const maxQEl = document.getElementById('maxQuestions');
            if (maxQEl) maxQEl.textContent = maxQuestions;
            
            const scoreEl = document.getElementById('score');
            if (scoreEl) scoreEl.textContent = '0';
            
            const totalEl = document.getElementById('total');
            if (totalEl) totalEl.textContent = '0';
            
            const percentageEl = document.getElementById('percentage');
            if (percentageEl) percentageEl.textContent = '-';
            
            const questionNumEl = document.getElementById('questionNum');
            if (questionNumEl) questionNumEl.textContent = '1';
            
            displayQuestion();
        }

        function returnToMenu() {
            // R√©initialiser les variables
            score = 0;
            total = 0;
            questionNumber = 1;
            askedQuestions = [];
            usedCorrectPairs = []; // R√©initialiser aussi les paires utilis√©es
            selectedGameMode = null;
            currentQuestion = null;
            
            // R√©initialiser l'affichage
            const scoreEl = document.getElementById('score');
            const totalEl = document.getElementById('total');
            const percentageEl = document.getElementById('percentage');
            const questionNumEl = document.getElementById('questionNum');
            
            if (scoreEl) scoreEl.textContent = '0';
            if (totalEl) totalEl.textContent = '0';
            if (percentageEl) percentageEl.textContent = '-';
            if (questionNumEl) questionNumEl.textContent = '1';
            
            // Afficher l'√©cran de s√©lection du mode
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('questionCountSelection').style.display = 'none';
            document.getElementById('gameContent').style.display = 'none';
        }

        function generateQuestion() {
            let attempts = 0;
            const maxAttempts = 200; // Augmenter le nombre de tentatives
            
            while (attempts < maxAttempts) {
                attempts++;
                
                const shuffled = [...availableOrganisms].sort(() => Math.random() - 0.5);
                
                if (shuffled.length < 3) {
                    return null;
                }
                
                const org1 = shuffled[0];
                const org2 = shuffled[1];
                const org3 = shuffled[2];
                
                if (org1.species === org2.species || org1.species === org3.species || org2.species === org3.species) {
                    continue;
                }
                
                const signature = getQuestionSignature(org1, org2, org3);
                if (askedQuestions.includes(signature)) {
                    continue;
                }
                
                const dist12 = getDivergenceTime(org1, org2);
                const dist13 = getDivergenceTime(org1, org3);
                const dist23 = getDivergenceTime(org2, org3);
                
                let closePair, distantOrg, closeTime, distantTime1, distantTime2;
                
                if (dist12 <= dist13 && dist12 <= dist23) {
                    closePair = [org1, org2];
                    distantOrg = org3;
                    closeTime = dist12;
                    distantTime1 = dist13;
                    distantTime2 = dist23;
                } else if (dist13 <= dist12 && dist13 <= dist23) {
                    closePair = [org1, org3];
                    distantOrg = org2;
                    closeTime = dist13;
                    distantTime1 = dist12;
                    distantTime2 = dist23;
                } else {
                    closePair = [org2, org3];
                    distantOrg = org1;
                    closeTime = dist23;
                    distantTime1 = dist12;
                    distantTime2 = dist13;
                }
                
                const maxDistantTime = Math.max(distantTime1, distantTime2);
                
                if (closeTime >= maxDistantTime * 0.9) {
                    continue;
                }
                
                // V√©rifier si cette paire correcte a d√©j√† √©t√© utilis√©e
                const pairSignature = getPairSignature(closePair[0], closePair[1]);
                if (usedCorrectPairs.includes(pairSignature)) {
                    continue; // Cette paire a d√©j√† √©t√© la bonne r√©ponse, on cherche une autre combinaison
                }
                
                // Marquer cette question et cette paire comme utilis√©es
                askedQuestions.push(signature);
                usedCorrectPairs.push(pairSignature);
                
                const orgs = [org1, org2, org3].sort(() => Math.random() - 0.5);
                
                const choices = [
                    { pair: [orgs[0], orgs[1]], text: orgs[0].emoji + ' ' + orgs[0].name + ' et ' + orgs[1].emoji + ' ' + orgs[1].name },
                    { pair: [orgs[0], orgs[2]], text: orgs[0].emoji + ' ' + orgs[0].name + ' et ' + orgs[2].emoji + ' ' + orgs[2].name },
                    { pair: [orgs[1], orgs[2]], text: orgs[1].emoji + ' ' + orgs[1].name + ' et ' + orgs[2].emoji + ' ' + orgs[2].name }
                ];
                
                return {
                    organisms: orgs,
                    choices: choices,
                    correctPair: closePair,
                    closeTime: closeTime,
                    distantTime: maxDistantTime
                };
            }
            
            // Si on n'a pas trouv√© de nouvelle question apr√®s maxAttempts
            // On peut soit r√©initialiser les paires utilis√©es, soit retourner null
            if (usedCorrectPairs.length > 0 && attempts >= maxAttempts) {
                // R√©initialiser et r√©essayer une fois
                usedCorrectPairs = [];
                return generateQuestion();
            }
            
            return null;
        }

        function displayQuestion() {
            if (total >= maxQuestions) {
                showFinalResults();
                return;
            }
            
            currentQuestion = generateQuestion();
            if (!currentQuestion) {
                alert('Erreur lors de la g√©n√©ration de la question');
                return;
            }
            
            const organismsDiv = document.getElementById('organisms');
            if (organismsDiv) {
                organismsDiv.innerHTML = currentQuestion.organisms
                    .map(org => 
                        '<div class="organism-box">' +
                        '<div class="organism">' + org.emoji + '</div>' +
                        '<div class="organism-label">' + org.name + '</div>' +
                        '</div>'
                    )
                    .join('');
            }
            
            const choicesDiv = document.getElementById('choices');
            if (choicesDiv) {
                choicesDiv.innerHTML = currentQuestion.choices
                    .map((choice, index) => 
                        '<div class="choice" onclick="checkAnswer(' + index + ')">' + choice.text + '</div>'
                    )
                    .join('');
            }
            
            const feedbackDiv = document.getElementById('feedback');
            if (feedbackDiv) {
                feedbackDiv.className = 'feedback';
            }
            
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.className = 'next-btn';
            }
            
            const questionNumEl = document.getElementById('questionNum');
            if (questionNumEl) {
                questionNumEl.textContent = questionNumber;
            }
        }

        function checkAnswer(choiceIndex) {
            total++;
            const choice = currentQuestion.choices[choiceIndex];
            const isCorrect = (choice.pair[0].species === currentQuestion.correctPair[0].species && 
                              choice.pair[1].species === currentQuestion.correctPair[1].species) ||
                             (choice.pair[0].species === currentQuestion.correctPair[1].species && 
                              choice.pair[1].species === currentQuestion.correctPair[0].species);
            
            if (isCorrect) score++;
            
            const choices = document.querySelectorAll('.choice');
            choices.forEach((choiceEl, index) => {
                choiceEl.classList.add('disabled');
                const pair = currentQuestion.choices[index].pair;
                const isThisCorrect = (pair[0].species === currentQuestion.correctPair[0].species && 
                                      pair[1].species === currentQuestion.correctPair[1].species) ||
                                     (pair[0].species === currentQuestion.correctPair[1].species && 
                                      pair[1].species === currentQuestion.correctPair[0].species);
                if (isThisCorrect) {
                    choiceEl.classList.add('correct');
                } else if (index === choiceIndex && !isCorrect) {
                    choiceEl.classList.add('incorrect');
                }
            });
            
            const feedback = document.getElementById('feedback');
            if (feedback) {
                feedback.className = 'feedback show ' + (isCorrect ? 'correct' : 'incorrect');
            }
            
            const org1 = currentQuestion.correctPair[0];
            const org2 = currentQuestion.correctPair[1];
            
            const wrongOrg = currentQuestion.organisms.find(o => 
                o.species !== org1.species && o.species !== org2.species
            );
            
            const commonClade = findCommonClade(org1, org2);
            
            if (feedback) {
                if (isCorrect) {
                    feedback.innerHTML = 
                        '<div class="feedback-title">‚úÖ Excellente r√©ponse !</div>' +
                        '<div class="feedback-content">' +
                        '<strong>' + org1.emoji + ' ' + org1.name + '</strong> (<em>' + org1.latin + '</em>) et ' +
                        '<strong>' + org2.emoji + ' ' + org2.name + '</strong> (<em>' + org2.latin + '</em>) ' +
                        'sont les deux esp√®ces les plus proches.' +
                        '<div class="time-info">' +
                        '‚è∞ <strong>Divergence √©volutive :</strong><br>' +
                        '‚Ä¢ Ces deux esp√®ces partagent la <strong>' + commonClade.level + '</strong> des <strong>' + commonClade.name + '</strong><br>' +
                        '‚Ä¢ Elles ont diverg√© il y a environ <span class="time-value">' + currentQuestion.closeTime + ' millions d\'ann√©es</span><br>' +
                        '‚Ä¢ ' + wrongOrg.name + ' a diverg√© il y a environ <span class="time-value">' + currentQuestion.distantTime + ' millions d\'ann√©es</span>' +
                        '</div>' +
                        '</div>';
                } else {
                    feedback.innerHTML = 
                        '<div class="feedback-title">‚ùå Pas tout √† fait...</div>' +
                        '<div class="feedback-content">' +
                        'La bonne r√©ponse √©tait <strong>' + org1.emoji + ' ' + org1.name + '</strong> ' +
                        'et <strong>' + org2.emoji + ' ' + org2.name + '</strong>.' +
                        '<div class="time-info">' +
                        '‚è∞ <strong>Pourquoi ?</strong><br>' +
                        '‚Ä¢ Ces deux esp√®ces partagent la <strong>' + commonClade.level + '</strong> des <strong>' + commonClade.name + '</strong><br>' +
                        '‚Ä¢ Elles ont diverg√© il y a seulement <span class="time-value">' + currentQuestion.closeTime + ' millions d\'ann√©es</span><br>' +
                        '‚Ä¢ ' + wrongOrg.name + ' s\'est s√©par√© il y a environ <span class="time-value">' + currentQuestion.distantTime + ' millions d\'ann√©es</span>' +
                        '</div>' +
                        '<div class="taxonomy-info">' +
                        org1.latin + ' et ' + org2.latin +
                        '</div>' +
                        '</div>';
                }
            }
            
            const scoreEl = document.getElementById('score');
            if (scoreEl) scoreEl.textContent = score;
            
            const totalEl = document.getElementById('total');
            if (totalEl) totalEl.textContent = total;
            
            const percentage = Math.round((score / total) * 100);
            const percentageEl = document.getElementById('percentage');
            if (percentageEl) percentageEl.textContent = percentage + '%';
            
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) nextBtn.className = 'next-btn show';
        }

        function nextQuestion() {
            questionNumber++;
            displayQuestion();
        }

        function showFinalResults() {
            const percentage = Math.round((score / total) * 100);
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                emoji = 'üèÜ';
                message = 'Expert en phylog√©nie ! F√©licitations !';
            } else if (percentage >= 75) {
                emoji = 'üåü';
                message = 'Excellent travail ! Tr√®s bonne ma√Ætrise !';
            } else if (percentage >= 60) {
                emoji = 'üëç';
                message = 'Bon travail ! Continue comme √ßa !';
            } else if (percentage >= 40) {
                emoji = 'üìö';
                message = 'Pas mal ! Il y a encore du potentiel !';
            } else {
                emoji = 'üí™';
                message = 'Continue √† t\'entra√Æner, tu vas progresser !';
            }
            
            const organismsDiv = document.getElementById('organisms');
            if (organismsDiv) {
                organismsDiv.innerHTML = 
                    '<div style="text-align: center; width: 100%;">' +
                    '<div style="font-size: 6em; margin-bottom: 20px;">' + emoji + '</div>' +
                    '<h2 style="font-size: 2em; margin-bottom: 20px;">Session termin√©e !</h2>' +
                    '<p style="font-size: 1.5em; margin-bottom: 10px;">Score final : <strong>' + score + ' / ' + total + '</strong></p>' +
                    '<p style="font-size: 1.3em; color: #667eea; margin-bottom: 30px;"><strong>' + percentage + '%</strong></p>' +
                    '<p style="font-size: 1.2em; color: #666;">' + message + '</p>' +
                    '</div>';
            }
            
            const choicesDiv = document.getElementById('choices');
            if (choicesDiv) {
                choicesDiv.innerHTML = '';
            }
            
            const feedbackDiv = document.getElementById('feedback');
            if (feedbackDiv) {
                feedbackDiv.className = 'feedback';
            }
            
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.className = 'next-btn';
            }
            
            const questionDiv = document.querySelector('.question');
            if (questionDiv) {
                questionDiv.innerHTML = '<strong>Merci d\'avoir jou√© !</strong><br>Voulez-vous recommencer ?';
            }
            
            const modeIndicator = document.querySelector('.game-mode-indicator');
            if (modeIndicator) {
                modeIndicator.innerHTML = 
                    '<button class="change-mode-btn" onclick="returnToMenu()" style="margin: 0 auto;">üîÑ Nouvelle session</button>';
            }
        }
    </script>
</body>
</html>